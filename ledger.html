<!DOCTYPE html>
<html>
<head>
    <title>User Ledger</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <style>
        body { font-family: Arial, sans-serif; padding: 15px; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { border: 1px solid #000; padding: 10px; text-align: left; }
        @media (max-width: 600px) {
            th, td { padding: 6px; font-size: 14px; }
        }
        .right { text-align: right; }
    </style>
</head>
<body>

<h2 id="partyTitle"></h2>

<table id="invoiceTable">
    <tr>
        <th>Date</th>
        <th>Type</th>
        <th>No</th>
        <th>Debit</th>
        <th>Credit</th>
        <th>Balance</th>
        <th>Download</th>
    </tr>
</table>

<script>
// ⚡ GET LOGGED USER ID
const userId = localStorage.getItem("loggedUser");

if (!userId) {
    alert("No user logged in!");
    window.location.href = "login.html";
}

document.getElementById("partyTitle").innerText = userId.toUpperCase() + " Ledger";

// XML path
const xmlpath = `bill/${userId}/${userId}.xml`;

// Convert XML → Array
async function loadLedgerXML(xmlText) {
    const parser = new DOMParser();
    const xml = parser.parseFromString(xmlText, "text/xml");

    const dates = [...xml.getElementsByTagName("DSPVCHDATE")];
    const accounts = [...xml.getElementsByTagName("DSPVCHLEDACCOUNT")];
    const types = [...xml.getElementsByTagName("DSPVCHTYPE")];
    const drs = [...xml.getElementsByTagName("DSPVCHDRAMT")];
    const crs = [...xml.getElementsByTagName("DSPVCHCRAMT")];
    const nos = [...xml.getElementsByTagName("DSPEXPLVCHNUMBER")];

    let result = [];

    for (let i = 0; i < dates.length; i++) {
        let noText = nos[i]?.textContent || "";
        let invoiceNo = noText.replace("(No. :", "").replace(")", "").trim();

        result.push({
            date: dates[i]?.textContent || "",
            type: types[i]?.textContent || "",
            debit: (drs[i]?.textContent || "").replace("-", ""),
            credit: crs[i]?.textContent || "",
            no: invoiceNo
        });
    }
    return result;
}

// Build table
function populateLedgerTable(data) {
    const table = document.getElementById("invoiceTable");
    let balance = 0;

    data.forEach(inv => {
        let debit = Number(inv.debit) || 0;
        let credit = Number(inv.credit) || 0;

        balance += debit - credit;

        let row = `
            <tr>
                <td>${inv.date}</td>
                <td>${inv.type}</td>
                <td>${inv.no}</td>
                <td class="right">${debit ? "₹" + debit : ""}</td>
                <td class="right">${credit ? "₹" + credit : ""}</td>
                <td class="right">₹${balance.toFixed(2)}</td>
                <td><button onclick="downloadInvoice('${inv.no}')">Download</button></td>
            </tr>
        `;

        table.innerHTML += row;
    });

    table.innerHTML += `
        <tr>
            <th colspan="5" class="right">Closing Balance</th>
            <th class="right">₹${balance.toFixed(2)}</th>
            <th></th>
        </tr>
    `;
}

// Load XML → Table
fetch(xmlpath)
    .then(res => res.text())
    .then(xmlText => loadLedgerXML(xmlText))
    .then(ledger => populateLedgerTable(ledger))
    .catch(err => {
        document.body.innerHTML += "<p style='color:red;'>Error loading ledger XML.</p>";
    });

// Placeholder for PDF extraction
function downloadInvoice(no) {
    alert("Download PDF for invoice: " + no);
}

</script>

</body>
</html>
